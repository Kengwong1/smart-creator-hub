import streamlit as st
import os
from dotenv import load_dotenv
import google.generativeai as genai
import time
import urllib.parse
from deep_translator import GoogleTranslator

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Smart Creator Hub v4.2", page_icon="üé¨", layout="wide")
load_dotenv()

# --- 2. ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏© (Secret Sauce) ---
# ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏≠‡∏ö‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏™‡∏ß‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö 8K ‡∏Ñ‡πà‡∏∞
MAGIC_SAUCE = ", cinematic lighting, hyper-realistic, highly detailed, 8k, masterpiece, sharp focus, professional photography"

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏°‡∏ï‡∏∞) ---
def translate_immortal(text):
    # ‡πÅ‡∏ú‡∏ô A: ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ Gemini ‡∏Å‡πà‡∏≠‡∏ô
    keys = st.secrets.get("GEMINI_KEYS", [])
    for key in keys:
        try:
            genai.configure(api_key=key)
            model = genai.GenerativeModel('gemini-flash-latest')
            res = model.generate_content(f"Translate to English image prompt: {text}")
            return res.text
        except:
            continue
            
    # ‡πÅ‡∏ú‡∏ô B: ‡∏ñ‡πâ‡∏≤ Gemini ‡πÄ‡∏ï‡πá‡∏° ‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏•‡∏ü‡∏£‡∏µ + ‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    try:
        translated = GoogleTranslator(source='th', target='en').translate(text)
        return translated + MAGIC_SAUCE
    except:
        return text + MAGIC_SAUCE

# --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Pollinations AI) ---
def get_img_url(prompt, width, height):
    encoded = urllib.parse.quote(prompt)
    seed = int(time.time())
    return f"https://image.pollinations.ai/prompt/{encoded}?width={width}&height={height}&seed={seed}&nologo=true&model=flux"

# --- 5. Sidebar ---
with st.sidebar:
    st.title("üé¨ Smart Creator Hub v4.2")
    st.write(f"‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á ‚ú®")
    menu = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:", ["üé® ‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πà‡∏ß‡∏ô", "üé¨ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå", "üí∞ ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤"])
    st.divider()
    st.caption("v4.2 | Super Backup System")

# --- 6. ‡πÇ‡∏ã‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---

if menu == "üé® ‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πà‡∏ß‡∏ô":
    st.header("üé® AI ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏°‡∏ï‡∏∞ (‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•)")
    img_input = st.text_area("‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ AI ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏≠‡∏∞‡πÑ‡∏£? (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ó‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞)", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏ã‡πà‡∏≠‡∏°‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡∏µ‡∏ó‡∏≠‡∏á")
    
    size = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î:", ["‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (9:16)", "‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (16:9)", "‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™ (1:1)"])
    if "9:16" in size: w, h = 540, 960
    elif "16:9" in size: w, h = 960, 540
    else: w, h = 768, 768

    if st.button("‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ"):
        if not img_input:
            st.warning("‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞")
        else:
            with st.spinner("‚è≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î..."):
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                is_english = all(ord(c) < 128 for c in img_input[:20])
                if is_english:
                    final_prompt = img_input + MAGIC_SAUCE
                else:
                    final_prompt = translate_immortal(img_input)
            
            with st.spinner("üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ..."):
                img_url = get_img_url(final_prompt, w, h)
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡πÜ
                st.success("‚ú® ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞!")
                html_img = f'<div style="display:flex; justify-content:center;"><img src="{img_url}" style="max-width:100%; max-height:75vh; border-radius:15px; box-shadow: 0px 8px 30px rgba(0,0,0,0.3);"></div>'
                
                if "9:16" in size:
                    c1, c2, c3 = st.columns([1, 2, 1])
                    with c2: st.markdown(html_img, unsafe_allow_html=True)
                else:
                    st.markdown(html_img, unsafe_allow_html=True)
                
                st.markdown(f'<div style="text-align:center; margin-top:20px;"><a href="{img_url}" target="_blank" style="padding:12px 24px; background-color:#FF4B4B; color:white; border-radius:8px; text-decoration:none; font-weight:bold;">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏°</a></div>', unsafe_allow_html=True)

elif menu == "üé¨ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå":
    # ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Gemini ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏â‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏ó‡∏¢‡∏Ñ‡πà‡∏∞
    topic = st.text_input("‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå")
    if st.button("‚ú® ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô"):
        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î..."):
            keys = st.secrets.get("GEMINI_KEYS", [])
            success = False
            for key in keys:
                try:
                    genai.configure(api_key=key)
                    model = genai.GenerativeModel('gemini-flash-latest')
                    res = model.generate_content(f"‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á {topic} ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢")
                    st.markdown(res.text)
                    success = True
                    break
                except: continue
            if not success: st.error("‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏£‡∏≠ 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞")