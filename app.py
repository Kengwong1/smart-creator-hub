import streamlit as st
import os
from dotenv import load_dotenv
import google.generativeai as genai
import time
import urllib.parse
from deep_translator import GoogleTranslator

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Smart Creator Hub v4", page_icon="üé¨", layout="wide")
load_dotenv()

# --- 2. ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ß‡∏¥‡πÄ‡∏®‡∏© (Style Dictionary) ---
STYLE_PRESETS = {
    "‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ï‡∏≤‡∏°‡πÉ‡∏à AI)": "",
    "‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏¢‡∏∏‡∏Ñ‡∏≠‡∏ß‡∏Å‡∏≤‡∏® (Cyber Repair)": ", cyberpunk, intricate circuitry, neon internal glow, macro lens, 8k, futuristic workshop",
    "‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Affiliate (Studio)": ", soft cinematic studio lighting, minimalist marble stand, bokeh background, high-end commercial, clean aesthetic",
    "‡πÑ‡∏ó‡∏¢‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏£‡πå‡∏ô (‡∏û‡∏ç‡∏≤‡∏ô‡∏≤‡∏Ñ/‡∏õ‡∏•‡∏≤‡∏Å‡∏±‡∏î)": ", Thai traditional Naga motif, iridescent scales, golden filigree, bioluminescent energy, digital art masterpiece",
    "‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á (Photorealistic)": ", hyper-realistic, shot on 85mm lens, sharp focus, natural textures, DSLR quality",
    "‡πÅ‡∏ô‡∏ß‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞ (Anime Style)": ", high-quality anime illustration, vibrant colors, Makoto Shinkai style, detailed background"
}

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Gemini ---
def call_ai(prompt_text):
    keys = st.secrets.get("GEMINI_KEYS", [])
    for key in keys:
        try:
            genai.configure(api_key=key)
            model = genai.GenerativeModel('gemini-flash-latest')
            res = model.generate_content(prompt_text)
            return res.text
        except: continue
    # ‡∏ñ‡πâ‡∏≤ Gemini ‡πÄ‡∏ï‡πá‡∏° ‡πÉ‡∏ä‡πâ Google Translate ‡πÅ‡∏ó‡∏ô (Bypass)
    try:
        return GoogleTranslator(source='th', target='en').translate(prompt_text)
    except: return prompt_text

# --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
def get_img_url(prompt, width, height, style_suffix):
    full_prompt = prompt + style_suffix
    encoded = urllib.parse.quote(full_prompt)
    seed = int(time.time())
    return f"https://image.pollinations.ai/prompt/{encoded}?width={width}&height={height}&seed={seed}&nologo=true&model=flux"

# --- 5. Sidebar ---
with st.sidebar:
    st.title("üé¨ Smart Creator Hub v4")
    st.write(f"‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á ‚ú®")
    menu = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:", ["‚ú® Magic Content (‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà)", "üé® ‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß", "üé¨ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô & ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô"])
    st.divider()
    st.caption("v4.0 | Power by Pollinations & Gemini")

# --- 6. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---

# --- 6.1 Magic Content (‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á) ---
if menu == "‚ú® Magic Content (‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà)":
    st.header("‚ú® Magic Content Package (‡∏à‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)")
    st.write("‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Ñ‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß AI ‡∏à‡∏∞‡πÄ‡∏™‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡πà‡∏∞!")
    
    topic = st.text_input("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£?", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ã‡πà‡∏≠‡∏°‡∏à‡∏≠ iPhone 15 ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏à‡∏¥‡πã‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏≠‡∏°")
    
    col_s1, col_s2 = st.columns(2)
    with col_s1:
        chosen_style = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å:", list(STYLE_PRESETS.keys()))
    with col_s2:
        chosen_size = st.selectbox("‡∏Ç‡∏ô‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:", ["‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (9:16)", "‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (16:9)", "‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™ (1:1)"])

    if st.button("üöÄ ‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà"):
        if not topic:
            st.warning("‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á")
        else:
            with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á..."):
                # 1. ‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                eng_p = call_ai(f"Detailed image prompt for: {topic}")
                w, h = (540, 960) if "9:16" in chosen_size else (960, 540) if "16:9" in chosen_size else (768, 768)
                img_url = get_img_url(eng_p, w, h, STYLE_PRESETS[chosen_style])
                
                # 2. ‡πÄ‡∏™‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ, ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô, ‡πÅ‡∏ú‡∏ô)
                text_res = call_ai(f"‡∏ó‡∏≥‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '{topic}' ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏î 1.‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ Viral, 2.‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤ Affiliate, 3.‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≥ (Script)")
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                st.divider()
                st.subheader("üñºÔ∏è ‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå")
                c1, c2, c3 = st.columns([1, 2, 1]) if "9:16" in chosen_size else st.columns([0.1, 5, 0.1])
                with c2:
                    st.markdown(f'<div style="text-align:center;"><img src="{img_url}" style="width:100%; border-radius:15px; box-shadow: 0px 10px 30px rgba(0,0,0,0.3);"></div>', unsafe_allow_html=True)
                    st.markdown(f'<div style="text-align:center; margin-top:15px;"><a href="{img_url}" target="_blank" style="padding:10px 20px; background-color:#FF4B4B; color:white; border-radius:8px; text-decoration:none; font-weight:bold;">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å</a></div>', unsafe_allow_html=True)
                
                st.divider()
                st.subheader("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå")
                st.markdown(text_res)

# --- 6.2 ‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ---
elif menu == "üé® ‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß":
    st.header("üé® AI ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ß‡∏¥‡πÄ‡∏®‡∏©)")
    img_input = st.text_area("‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏π‡∏õ‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?", placeholder="‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÅ‡∏°‡∏ß‡∏ã‡πà‡∏≠‡∏°‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠")
    
    c1, c2 = st.columns(2)
    with c1:
        style = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ß‡∏¥‡πÄ‡∏®‡∏©:", list(STYLE_PRESETS.keys()))
    with c2:
        size = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î:", ["‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (9:16)", "‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (16:9)", "‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™ (1:1)"])
        
    if st.button("‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ"):
        with st.spinner("üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡πÄ‡∏•‡∏á‡∏®‡∏¥‡∏•‡∏õ‡∏∞..."):
            eng_prompt = call_ai(f"Detailed image prompt for: {img_input}")
            w, h = (540, 960) if "9:16" in size else (960, 540) if "16:9" in size else (768, 768)
            final_url = get_img_url(eng_prompt, w, h, STYLE_PRESETS[style])
            
            st.markdown(f'<div style="display:flex; justify-content:center;"><img src="{final_url}" style="max-width:100%; max-height:75vh; border-radius:12px; box-shadow:0px 8px 25px rgba(0,0,0,0.3);"></div>', unsafe_allow_html=True)
            st.markdown(f'<div style="text-align:center; margin-top:20px;"><a href="{final_url}" target="_blank" style="padding:10px 20px; background-color:#FF4B4B; color:white; border-radius:8px; text-decoration:none;">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a></div>', unsafe_allow_html=True)

# --- 6.3 ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô & ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô ---
elif menu == "üé¨ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô & ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô":
    st.header("üé¨ ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå & Affiliate")
    action = st.selectbox("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞?", ["‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤‡πÅ‡∏£‡∏á‡πÜ", "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠", "‡∏Ñ‡∏¥‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡πÉ‡∏à", "‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÅ‡∏ü‡∏ô‡∏Ñ‡∏•‡∏±‡∏ö"])
    txt_input = st.text_area("‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞:")
    
    if st.button("‚ú® ‡πÉ‡∏´‡πâ AI ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"):
        with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•..."):
            res = call_ai(f"‡∏ó‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '{action}' ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ: {txt_input}")
            st.code(res) if "‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô" in action or "‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå" in action else st.markdown(res)