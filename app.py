import streamlit as st
import os
from dotenv import load_dotenv
import google.generativeai as genai
import requests
import io
from PIL import Image
import time

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Smart Creator Hub", page_icon="üé¨", layout="wide")
load_dotenv()

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Gemini (‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) ---
def call_gemini_with_retry(prompt_text):
    keys = st.secrets.get("GEMINI_KEYS", [])
    if not keys:
        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö GEMINI_KEYS ‡πÉ‡∏ô Secrets")
        st.stop()
    
    for idx, key in enumerate(keys):
        try:
            genai.configure(api_key=key)
            model = genai.GenerativeModel('gemini-flash-latest')
            response = model.generate_content(prompt_text)
            return response.text
        except Exception as e:
            if "429" in str(e) or "ResourceExhausted" in str(e):
                if idx < len(keys) - 1:
                    time.sleep(2)
                    continue
                else:
                    st.error("‚ùå ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ Gemini ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏û‡∏±‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ")
                    st.stop()
    return None

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ (‡∏£‡∏∞‡∏ö‡∏ö‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà FLUX & SDXL) ---
def generate_image_immortal(prompt, width, height, hf_key):
    # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏∞
    models = [
        "black-forest-labs/FLUX.1-schnell", # ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        "stabilityai/stable-diffusion-xl-base-1.0",
        "CompVis/stable-diffusion-v1-4" # ‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏•‡πà‡∏°
    ]
    
    headers = {"Authorization": f"Bearer {hf_key}"}
    payload = {
        "inputs": prompt,
        "parameters": {"width": width, "height": height}
    }

    for model_path in models:
        api_url = f"https://api-inference.huggingface.co/models/{model_path}"
        try:
            st.write(f"üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô: {model_path}...")
            response = requests.post(api_url, headers=headers, json=payload, timeout=40)
            
            if response.status_code == 200:
                return response.content, model_path
            elif response.status_code == 503:
                # ‡∏ñ‡πâ‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏Ñ‡πà‡∏∞
                st.info(f"‚è≥ {model_path} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏µ... ‡∏£‡∏≠ 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞")
                time.sleep(20)
                response = requests.post(api_url, headers=headers, json=payload, timeout=40)
                if response.status_code == 200: return response.content, model_path
            
            # ‡∏´‡∏≤‡∏Å 410 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            continue
            
        except Exception:
            continue
            
    raise Exception("‚ùå ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞")

# --- 4. Sidebar ---
with st.sidebar:
    st.title("üé¨ Smart Creator Hub")
    st.write(f"‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á ‚ú®")
    menu = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:", ["üé® ‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ AI", "üé¨ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå", "üí∞ ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤", "üîç ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ", "üí¨ ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå"])
    st.divider()
    st.caption("v2.8 | FLUX & SDXL Support")

# --- 5. ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
if menu == "üé® ‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ AI":
    st.header("üé® AI ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Next-Gen Edition)")
    img_desc = st.text_area("‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏π‡∏õ‡∏≠‡∏∞‡πÑ‡∏£? (‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)", height=100, placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏ã‡πà‡∏≠‡∏°‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà ‡πÅ‡∏™‡∏á‡∏™‡∏µ‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô")
    
    size_option = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏†‡∏≤‡∏û:", ["‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (9:16)", "‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (16:9)", "‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™ (1:1)"])
    if "9:16" in size_option: w, h = 512, 896
    elif "16:9" in size_option: w, h = 896, 512
    else: w, h = 768, 768

    if st.button("‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ"):
        hf_api_key = st.secrets.get("HUGGINGFACE_API_KEY")
        if not img_desc:
            st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞")
        else:
            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
            is_english = all(ord(c) < 128 for c in img_desc[:50])
            
            with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏†‡∏≤‡∏û..."):
                if is_english:
                    eng_prompt = img_desc
                else:
                    eng_prompt = call_gemini_with_retry(f"Write a very short, high-quality image prompt in English for: {img_desc}")
            
            if eng_prompt:
                try:
                    with st.spinner("üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û... (‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞)"):
                        img_bytes, used_model = generate_image_immortal(eng_prompt, w, h, hf_api_key)
                        image = Image.open(io.BytesIO(img_bytes))
                        st.image(image, caption=f"‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢: {used_model}", use_container_width=True)
                        
                        buf = io.BytesIO()
                        image.save(buf, format="PNG")
                        st.download_button("üì• ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ", data=buf.getvalue(), file_name="ai_creator.png", mime="image/png")
                except Exception as e:
                    st.error(str(e))

# --- ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÉ‡∏ä‡πâ Gemini ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∏‡∏ç‡πÅ‡∏à) ---
elif menu == "üé¨ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå":
    topic = st.text_input("‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠")
    if st.button("‚ú® ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô"):
        res = call_gemini_with_retry(f"‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå: {topic}")
        if res: st.markdown(res)

elif menu == "üí∞ ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤":
    details = st.text_area("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    if st.button("üí∏ ‡πÄ‡∏™‡∏Å‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô"):
        res = call_gemini_with_retry(f"‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤: {details}")
        if res: st.code(res)

elif menu == "üîç ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ":
    topic_name = st.text_input("‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏õ")
    if st.button("üöÄ ‡∏Ñ‡∏¥‡∏î‡∏ä‡∏∑‡πà‡∏≠"):
        res = call_gemini_with_retry(f"‡∏Ñ‡∏¥‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ Viral 5 ‡πÅ‡∏ö‡∏ö: {topic_name}")
        if res: st.markdown(res)

elif menu == "üí¨ ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå":
    comment = st.text_area("‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå")
    if st.button("üí≠ ‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö"):
        res = call_gemini_with_retry(f"‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å: {comment}")
        if res: st.code(res)